# Observability Methods Screen Demo

This repository shows examples of the GenAI application in four languages: Go, Java, NodeJS and Python.
The examples demonstrate instrumentation of the application with OpenTelemetry tracing and custom metric.
And the use of structured logs that correlate with traces using the native logging packages of the languages. The telemetry data generated by the applications is written to Google Cloud.

All examples are designed to run as Cloud Run services. See deployment instructions below.

Using these examples you can quickly learn how to do the following (in Go, Java, NodeJS and Python):

* Write logs using [embedded logging agent](https://cloud.google.com/run/docs/logging#container-logs) and without need for specialized package that writes logs to Cloud Logging
* Write logs with [structured payload](https://cloud.google.com/logging/docs/structured-logging#special-payload-fields) (in the JSON format) and customize log entry's severity or store custom metadata (in the form of user's labels)
* Use OpenTelemetry SDK for generating and exporting metrics and traces
* Using native Google Cloud OTLP endpoints
* Correlating logs and traces to improve observability of your application based on telemetry data

## Deployment

The following steps describe deployment of the examples to Cloud Run.
The instructions assume that the ID of the Google Cloud project hosting the example is stored in the environment variable named `PROJECT_ID`.
The instructions use `LANGUAGE` environment variable to determine the programming language of the example.
The language can have only one of the following values: `go`, `java`, `nodejs` or `python`.

To run the instructions you will need [`gcloud` CLI](https://cloud.google.com/sdk/docs/install).
Run the following commands in a command shell:

1. Make sure you are located in the root folder of the repository.
1. Enable all required Google APIs:

   ```shell
   gcloud services enable \
     aiplatform.googleapis.com \
     artifactregistry.googleapis.com \
     cloudbuild.googleapis.com \
     run.googleapis.com \
     telemetry.googleapis.com \
     --project=${PROJECT_ID}
   ```

1. Deploy the example from code to Cloud Run:

   ```shell
   gcloud run deploy "${LANGUAGE}-o11y-service" \
     --source="./${LANGUAGE}/" \
     --region=us-central1 \
     --allow-unauthenticated \
     --project=${PROJECT_ID}
   ```

> [!TIP]
> You can deploy the example to any region by replacing the "us-central1" in the `--region=us-central1` argument with your region name.

> [!WARNING]
> The application is deployed with free access, hence exposed to Deny of Wallet.
  Be aware or replace the `--allow-unauthenticated` argument with the `--no-allow-unauthenticated` to require a user to authenticate.

### Permissions

The instructions deploy the Cloud Run services using the identity of the [default](https://cloud.google.com/iam/docs/service-account-types#default) compute service account of the project.
Make sure that the service account has at least the following roles:

* roles/aiplatform.user
* roles/logging.logWriter
* roles/monitoring.metricWriter
* roles/telemetry.tracesWriter

## Cleanup

The fastest and complete way to cleanup is to delete the Google Cloud project where you deployed the demo application(s). For a project with ID `PROJECT_ID` run the following gcloud CLI command:

```shell
gcloud projects delete PROJECT_ID --quiet
```

Deleting just Cloud Run services does not clean up artifacts created by Cloud Build and does not delete observability data in Cloud Logging, Cloud Monitoring and Cloud Trace.

## Create log-based metrics

The examples write performance metrics using OpenTelemetry SDK.
It is possible to use [log-based metrics](https://cloud.google.com/logging/docs/logs-based-metrics) using the logs that demo application writes.
The following commands will create a log-based metric for the application.
Because all examples use the same structured payload for their logs, the command will calculate the metric based on all logs that were ingested into the project.
The metric will use the label with the name of the Cloud Run service (similar to the label set for the custom metrics).

```shell
cat > "/tmp/log-metric-config.json" <<EOF
{
  "name": "lb_model_call_count",
  "description": "Number of log entries capturing successful call to model inference",
  "filter": "LOG_ID(\"run.googleapis.com%2Fstdout\") AND severity=DEBUG",
  "labelExtractors": {
    "service": "resource.service_name"
  }
}
EOF

gcloud logging metrics create lb_model_call_count \
  --project=${PROJECT_ID} \
  --config-from-file=/tmp/log-metric-config.json
```
